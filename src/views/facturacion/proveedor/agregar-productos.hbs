<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Hugo 0.80.0">
  <title>Thomson - Facturacion</title>



  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/facturacion-forms.css">

  <!-- Favicons -->


  <!-- Custom styles for this template -->
  <link href="/css/dashboard.css" rel="stylesheet">
</head>

<body>
 <header>
        <nav class="navbar navbar-expand-md navbar-dark bg-dark ">
            <div class="container-fluid">
                <a href="/Facturacion">
                    <img src="/css/assets/logo.png" alt="LOGO" width="150px" height="30px" id="logo" />
                </a>
                <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="toggle navigation">
                    <span class="navbar-toggler-icon"> </span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto">
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Facturación</a>
                            <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdownMenuLink">
                                <li><a class="nav-link" href="/facturacion/nueva-factura">Nueva-factura</a></li>
                                <li class="dropdown-submenu"><a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Facturas</a>
                                    <ul class="dropdown-menu dark2 bg-dark">
                                        <li><a class="nav-link" href="/facturacion/por-cobrar">Por cobrar</a></li>
                                        <li><a class="nav-link" href="/facturacion/cobradas">Cobradas</a></li>
                                        <li><a class="nav-link" href="/facturacion/ventas">Ventas</a></li> <!--Todas -->
                                        <li><a class="nav-link" href="/facturacion/anular-factura">Anular</a></li>
                                        <li><a class="nav-link" href="/facturacion/ordenes-compra">Orden de compra</a></li> <!--Pedidos de los clientes-->
                                        <li><a class="nav-link" href="/facturacion/nueva-cotizacion">Cotización</a></li> 
                                        <li><a class="nav-link" href="/facturacion/ver-cotizaciones">Ver cotizaciones</a></li> 
                                        <li><a class="nav-link" href="/facturacion/libro-contable">Libro contable</a></li> <!--Realizar cotizaciones sin afectar stock-->
                                    </ul>
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Cobranza</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                <a class=" dropdown-item text-light" href="/facturacion/cobranza">
                                    <p class="name_product nav-link">Cobranza</p>
                                </a>
                                  <a class=" dropdown-item text-light" href="/facturacion/devolucion">
                                    <p class="name_product nav-link">Realizar Devolución</p>
                                </a>
                                <a class=" dropdown-item text-light" href="/facturacion/todas-devoluciones">
                                    <p class="name_product nav-link">Devoluciones</p>
                                </a>
                                <a class=" dropdown-item text-light" href="/facturacion/todos-recibos">
                                    <p class="name_product nav-link">Recibos de pago</p>
                                </a>
                                <a class=" dropdown-item text-light" href="/facturacion/reporte-cxc">
                                    <p class="name_product nav-link">Reporte de cuentas por cobrar</p>
                                </a>
                                
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Inventario</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                <a class=" dropdown-item text-light" href="/facturacion/registrar-stock">
                                    <p class="name_product nav-link">Crear Artículo</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/stock">
                                    <p class="name_product nav-link">Editar Artículo</p>
                                </a>
                                      <a class=" dropdown-item text-light" href="/facturacion/registrar-garantias">
                                    <p class="name_product nav-link">Registrar garantías</p>
                                </a>
                                    <a class=" dropdown-item text-light" href="/facturacion/ver-garantias">
                                    <p class="name_product nav-link">Ver garantías</p>
                                </a>
                                </a>
                                    <a class=" dropdown-item text-light" href="/facturacion/estado-inventario">
                                    <p class="name_product nav-link">Estado de inventario</p>
                                </a>
                                 <a class=" dropdown-item text-light" href="/facturacion/reporte-ajustes">
                                    <p class="name_product nav-link">Reporte de movimientos</p>
                                </a>
                               <a class=" dropdown-item text-light" href="/facturacion/reporte-de-articulos">
                                    <p class="name_product nav-link">Reporte de articulos</p>
                                </a>
                                  <a class=" dropdown-item text-light" href="/facturacion/cambio-masivo-costo">
                                    <p class="name_product nav-link">Cambio masivo de costos</p>
                                </a>
                                  <a class=" dropdown-item text-light" href="/facturacion/reporte-stock">
                                    <p class="name_product nav-link">Reporte de stock</p>
                                </a>
                                  <li class="dropdown-submenu"><a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Ajuste de inventario</a>
                                    <ul class="dropdown-menu dark2 bg-dark">
                                        <li><a class="nav-link" href="/facturacion/descargar-stock">Descargar</a></li>
                                        <li><a class="nav-link" href="/facturacion/cargar-stock">Cargar</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>

                        <li>
                            <li class="nav-item dropdown">
                             <a class="nav-link active dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Proveedor</a>
                                <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                    <a class=" dropdown-item text-light" href="/facturacion/crear-proveedor">
                                        <p class="name_product nav-link">Crear</p>
                                    </a>
                                    <a class="dropdown-item text-light" href="/facturacion/editar-proveedor">
                                        <p class="name_product nav-link">Editar</p>
                                    </a>
                                        <a class="dropdown-item text-light" href="/facturacion/realizar-ordenes">
                                        <p class="name_product nav-link">Realizar orden</p>
                                    </a>
                                    <a class="dropdown-item text-light" href="/facturacion/ordenes-proveedor">
                                        <p class="name_product nav-link">Lista de ordenes</p>
                                    </a>
                                    <a class="dropdown-item text-light" href="/facturacion/reporte-de-proveedores">
                                        <p class="name_product nav-link">Reporte de proveedores</p>
                                    </a>
                                </ul>
                            </li>
                        </li>

                        <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">Cliente</a>
                        <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                            <a class=" dropdown-item text-light" href="/facturacion/registrar-cliente">
                                <p class="name_product nav-link">Registrar</p>
                            </a>
                            <a class="dropdown-item text-light" href="/facturacion/clientes">
                                <p class="name_product nav-link">Editar</p>
                            </a>
                            <a class="dropdown-item text-light" href="/facturacion/aprobar-usuarios">
                                <p class="name_product nav-link">Aprobar o rechazar</p>
                            </a>
                            <a class="dropdown-item text-light" href="/facturacion/pausar-activar-cliente">
                                <p class="name_product nav-link">Pausar o activar</p>
                            </a>
                            <a class="dropdown-item text-light" href="/facturacion/reporte-cliente">
                                <p class="name_product nav-link">Reportes</p>
                            </a>
                            <a class="dropdown-item text-light" href="/facturacion/reportes-precio">
                                <p class="name_product nav-link">Lista de precios</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/solicitudes-recuperacion-contrasena">
                                <p class="name_product nav-link">Solicitudes de recuperación</p>
                            </a>
                        </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Vendedor</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                <a class=" dropdown-item text-light" href="/facturacion/registrar-vendedor">
                                    <p class="name_product nav-link">Registrar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/vendedores">
                                    <p class="name_product nav-link">Editar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/reporte-vendedores">
                                    <p class="name_product nav-link">Reportes</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/pausar-activar-vendedor">
                                    <p class="name_product nav-link">Pausar o activar</p>
                                </a>
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Transporte</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                               <a class=" dropdown-item text-light" href="/facturacion/registrar-transporte">
                                    <p class="name_product nav-link">Registrar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/transportes">
                                    <p class="name_product nav-link">Editar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/activar-inactivar-transporte">
                                    <p class="name_product nav-link">Pausar o activar</p>
                                </a>
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Registrar perfil</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                <a class=" dropdown-item text-light" href="/facturacion/registrar-usuario">
                                    <p class="name_product nav-link">Registrar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/usuarios">
                                    <p class="name_product nav-link">Editar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/pausar-activar-usuario">
                                    <p class="name_product nav-link">Pausar o activar</p>
                                </a>
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Comisión</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item text-light" href="/facturacion/comision/por-cancelar">
                                    <p class="name_product nav-link">Por cancelar</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/comision/canceladas">
                                    <p class="name_product nav-link">Canceladas</p>
                                </a>
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Administración</a>
                                   <ul class="dropdown-menu dark2 bg-dark" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item text-light" href="/facturacion/administracion">
                                    <p class="name_product nav-link">Libro de entradas y salidas</p>
                                </a>
                                <a class="dropdown-item text-light" href="/facturacion/cuentas-por-pagar">
                                    <p class="name_product nav-link">Cuentas por pagar</p>
                                </a>
                            </ul>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link" href="/facturacion/agenda">Agenda</a>
                        </li>
                        
                         <li class="nav-item">
                            <a class="nav-link" href="/facturacion/dashboard">Dashboard</a>
                        </li>

                    </ul>
                       <ul class="navbar-nav ml-0 mr-0">
                            <li class="nav-item">
                                <a class="nav-link" href="/usuarios/cerrar-sesion">
                                    <button class="btn btn-outline-success" type="button">
                                        Cerrar sesión
                                    </button>
                                </a>
                            </li>
                        </ul>
                </div>
            </div>
        </nav>
    </header>

   <main>
      <div   id="spinner">
      </div>
         <div id="errors" class="container-fluid mt-2">
         </div>
       <div class="container-fluid mt-4 mb-4">
           <div class="row">
               <h2 class="text-center" id="orden" data-orden="{{orden}}">Orden de compra #{{orden}}</h2>
           </div>
       </div>
       
        <div class="table-responsive mt-2">
            <table class="table table-dark table-striped table-hover table-sm" id="tabla">
              <thead class="thead-dark">
                <tr>
                  <th class="text-center text-light" scope="col">Proveedor</th>
                  <th class="text-center text-light" scope="col">Código</th>
                  <th class="text-center text-light" scope="col">Homólogo</th>
                  <th class="text-center text-light" scope="col">Descripción</th>
                  <th class="text-center text-light" scope="col">Posición</th>
                  <th class="text-center text-light" scope="col">Modelo</th>
                  <th class="text-center text-light" scope="col">Cantidad en stock</th>
                  <th class="text-center text-light" scope="col">Cantidad vendida</th>
                  <th class="text-center text-light" scope="col">Precio</th>
                  <th class="text-center text-light" scope="col">Por comprar</th>
                  <th class="text-center text-light" scope="col">Agregar a lista</th>
                </tr>
                <td colspan="14">
                  <input
                    id="buscar"
                    type="text"
                    class="form-control"
                    placeholder="Escriba su busqueda para filtar"
                  />
                </td>
              </thead>
              <tbody id="tbody">

              </tbody>
            </table>
          </div>
    </main>

  <!--<script src="/js/facturacion/orden-proveedor.js"></script>-->
  <script>
        document.addEventListener("keydown", e => {
            if(e.keyCode == 120 ){
                window.open('/facturacion/acceso-directo-stock', 'Stock', "width=1400, heigh=100%")
            }
        })
      //codigo de realizar orden
      const d = document

      const orden = d.getElementById("orden").getAttribute("data-orden")
      const  $AgregadosMcpherson = d.getElementById("AgregadosMcpherson")   
      const  $AgregadosConvencionales = d.getElementById("AgregadosConvencionales")   
      const  $AgregadosBases = d.getElementById("AgregadosBases")   
      const  $AgregadosGuardapolvo = d.getElementById("AgregadosGuardapolvo")   
      const  $agregados = d.getElementById("agregados")   
      const  $agregadosCosto = d.getElementById("agregadosCosto")   
      const $Proveedor = d.getElementById("Proveedor")
      const busqueda = d.getElementById("buscar")
      const $spinner = d.getElementById("spinner")
      const table = document.getElementById("tabla").tBodies[0];
      let  validacionCodigo = true;
      fetch("/solicitar-info-todos-productos-agregar", {
        method: "POST",
      })
        .then((response) => {
          return response.json();
        })
        .then((response	) => {
          let body = ""
          for(i=0; i< response.length; i++){
            let tr = `
              <tr>
                  <td class="text-light text-center"><p>${response[i].Proveedor}</p></th>
                    <td class="text-light text-center"><p>${response[i].CodigoT}</p></th>
                    <td class="text-light text-center"><p>${response[i].CodigoG}</p></td>
                    <td class="text-light text-center"><p>${response[i].Descripcion}</p></td>
                    <td class="text-light text-center"><p>${response[i].Posicion}</p></td>
                    <td class="text-light text-center"><p>${response[i].Familia}</p></td>
                    <td class="text-light text-center">${response[i].CantidadTotal}</td>
                    <td class="text-light text-center">${response[i].CantidadVendida}</td>
                    <td class="text-light text-center">${response[i].Precio}</td>
                    <td class="text-light text-center"><input type="number" data-input="cantidad"  min="0" value="0" class="w-100 form-control"/></td>
                    <td class="text-light text-center"><button class="btn btn-warning">Agregar</button></td>
                    <td class="text-light text-center" style="display: none"><p>${response[i].Costo}</p></td>
                    <td class="text-light text-center" style="display: none"><p>${response[i].CostoGranMayor}</p></td>
                    <td class="text-light text-center" style="display: none"><p>${response[i].CostoMayor}</p></td>
                    <td class="text-light text-center" style="display: none"><p>${response[i].CostoDetal}</p></td>
                    <td class="text-light text-center" style="display: none"><p>${response[i].TipoProducto}</p></td>
                    <td class="text-light text-center" style="display: none"><p>${response[i].Posicion}</p></td>
              </tr>
            `
            body += tr
          }
            table.innerHTML = body
          $spinner.setAttribute('hidden',"")
        })
   
      
      //busqueda tabla y proveedor
      let buscaTabla = function () {
      texto = busqueda.value.toLowerCase();
      let r = 0;
      while ((row = table.rows[r++])) {
        if (row.innerText.toLowerCase().indexOf(texto) !== -1)
          row.style.display = null;
        else row.style.display = "none";
      }
    };
    busqueda.addEventListener("keydown", e => {
      if(e.keyCode == 13){
      e.preventDefault()
      }
    })

    busqueda.addEventListener("keyup", buscaTabla);


    let buscaProveedor = function () {
      texto = $Proveedor.value.toLowerCase();
      let r = 0;
      while ((row = table.rows[r++])) {
        if (row.innerText.toLowerCase().indexOf(texto) !== -1)
          row.style.display = null;
        else row.style.display = "none";
      }
    };
      
      //busqueda tabla y proveedor
      
      const enviarProductoServidor = async (data) => {
        return await fetch(`/enviar-producto-orden-existente-proveedor/${orden}`, {
          method: "POST",
          body: JSON.stringify(data),
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
        })
          .then((response) => {
            return response.json()
          }).then((response) => {
               d.getElementById("errors").innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                      Código agregado correctamente.
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                  `

          })
      };
      const validarCodigoOrden = async (data) => {
        return await fetch(`/validar-codigo-orden-existente-proveedor/${orden}` , {
          method: "POST",
          body: JSON.stringify(data),
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
        })
          .then((response) => {
            return response.json()
          }).then( (response) => {
            console.log(response.validacion)
             validacionCodigo =  response.validacion
          })
      };

    d.addEventListener("click", async  e=> {
      if(e.target.textContent == "Agregar"){
        let fila = e.target.parentElement.parentElement
        if(fila.children[9].firstElementChild.value >0){
            let Proveedor = fila.children[0].firstElementChild.textContent
             let producto = {
                CodigoT: fila.children[1].firstElementChild.textContent,
                CodigoG: fila.children[2].firstElementChild.textContent,
                Descripcion: fila.children[3].firstElementChild.textContent,
                Posicion: fila.children[4].firstElementChild.textContent,
                Modelo: fila.children[5].firstElementChild.textContent,
                TipoProducto: fila.children[15].firstElementChild.textContent,
                Costo: fila.children[11].firstElementChild.textContent,
                CostoGranMayor: fila.children[12].firstElementChild.textContent,
                CostoMayor: fila.children[13].firstElementChild.textContent,
                CostoDetal: fila.children[14].firstElementChild.textContent,
                Posicion: fila.children[16].firstElementChild.textContent,
                Cantidad: fila.children[9].firstElementChild.value,
                PrecioUnidad: fila.children[8].textContent.replace("$", ""),
                PrecioTotal: (+fila.children[9].firstElementChild.value * +fila.children[8].textContent.replace("$", "")  ).toFixed(2),
              };
              let data = {
                CodigoT: fila.children[1].firstElementChild.textContent
              }
              await validarCodigoOrden(data)
              console.log(validacionCodigo)
              if(validacionCodigo){
                //codigo no existe y agregamos
                let data2 = {
                  producto : producto,
                  proveedor  : Proveedor
                }

                enviarProductoServidor(data2)
                fila.children[12].firstElementChild.value = 0

              }else{
                  d.getElementById("errors").innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                      El código que intenta agregar ya se encuentra en la lista. Por favor, valide e intente de nuevo.
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                  `
              }

        }else{
          //mandar error
        }
      }
    })

    </script>

<footer class="footer" style="background-color: rgba(41, 41, 41, 0.99);">
    <div class=" text-center mt-2 mb-2">
        <span class="text-muted">SISTEMA ADMINISTRATIVO THOMSON</span>
    </div>
</footer>
</body>

</html>